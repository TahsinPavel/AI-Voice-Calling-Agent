<!doctype html>

<html>
<head>
  <meta charset="utf-8" />
  <title>Bangla AI Receptionist — Test</title>
</head>
<body>
  <h2>Bangla AI Receptionist — Test UI</h2>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <div>
    <input type="text" id="messageInput" placeholder="Type your message here..." />
    <button id="sendMessage">Send Message</button>
  </div>
  <div id="log"></div>
  <audio id="player" controls></audio>

<script src="config.js"></script>
<script>
// Get WebSocket URL from environment or use default
const WEBSOCKET_URL = window.WEBSOCKET_URL || 
  (window.location.hostname.includes('railway.app') 
    ? `wss://${window.location.host}/ws/ai` 
    : `ws://${window.location.host}/ws/ai`);

const log = (m) => document.getElementById('log').innerText += '\n' + m;
let ws;
let audioContext;
let audioQueue = [];
let audioProcessingNode = null;

document.getElementById('start').onclick = async () => {
  // Use the correct WebSocket URL based on environment
  const wsUrl = WEBSOCKET_URL.startsWith('ws') ? WEBSOCKET_URL : 
    (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + WEBSOCKET_URL;
  
  console.log('Connecting to WebSocket:', wsUrl);
  ws = new WebSocket(wsUrl);
  
  ws.onopen = () => {
    log("WebSocket connected");
    document.getElementById('start').disabled = true;
    document.getElementById('stop').disabled = false;
  };
  
  ws.onmessage = async (event) => {
    if (event.data instanceof Blob) {
      log("Received audio data");
      // Handle audio data
      const arrayBuffer = await event.data.arrayBuffer();
      const audioBlob = new Blob([arrayBuffer], { type: 'audio/mp3' });
      const audioUrl = URL.createObjectURL(audioBlob);
      
      const player = document.getElementById('player');
      player.src = audioUrl;
      player.play();
    } else {
      log("Message: " + event.data);
      // Handle text messages
      if (event.data.startsWith("AI: ")) {
        log("Playing AI response");
      }
    }
  };
  
  ws.onerror = (error) => {
    log("WebSocket error: " + error);
  };
  
  ws.onclose = () => {
    log("WebSocket connection closed");
    document.getElementById('start').disabled = false;
    document.getElementById('stop').disabled = true;
  };
};

document.getElementById('stop').onclick = () => {
  if (ws) {
    ws.close();
  }
  document.getElementById('start').disabled = false;
  document.getElementById('stop').disabled = true;
};

document.getElementById('sendMessage').onclick = () => {
  const messageInput = document.getElementById('messageInput');
  const message = messageInput.value;
  if (message && ws && ws.readyState === WebSocket.OPEN) {
    ws.send("User: " + message);
    log("Sent: " + message);
    messageInput.value = "";
  }
};
</script>
</body>
</html>